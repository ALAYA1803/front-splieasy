<p-button
  [label]="'CONTRIBUTIONS.NEW_BUTTON' | translate"
  icon="pi pi-plus"
  (onClick)="abrirDialogo()"
  class="mb-3">
</p-button>

<br>
<br>
<p-table
  [value]="contributions"
  dataKey="id"
  class="p-datatable-sm"
  [loading]="loading">

  <ng-template pTemplate="header">
    <tr>
      <th>{{ 'CONTRIBUTIONS.TABLE.HEADER.DESCRIPTION' | translate }}</th>
      <th>{{ 'CONTRIBUTIONS.TABLE.HEADER.STRATEGY' | translate }}</th>
      <th>{{ 'CONTRIBUTIONS.TABLE.HEADER.DUE_DATE' | translate }}</th>
      <th>{{ 'CONTRIBUTIONS.TABLE.HEADER.TOTAL_AMOUNT' | translate }}</th>
      <th>{{ 'CONTRIBUTIONS.TABLE.HEADER.ACTIONS' | translate }}</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-contribution>
    <tr>
      <td>
        <i
          [class]="contribution.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
          (click)="contribution.expanded = !contribution.expanded"
          class="toggler cursor-pointer mr-2">
        </i>
        {{ contribution.description }}
      </td>

      <td>
        {{ (contribution.strategy === 'EQUAL'
        ? 'CONTRIBUTIONS.STRATEGIES.EQUAL'
        : 'CONTRIBUTIONS.STRATEGIES.INCOME_BASED') | translate }}
      </td>

      <td>{{ contribution.fechaLimite | date:'dd/MM/yyyy' }}</td>
      <td>{{ contribution.montoTotal | currency:'PEN':'symbol':'1.2-2' }}</td>

      <td class="flex align-items-center gap-2">
        <p-button
          icon="pi pi-eye"
          class="p-button-rounded p-button-text p-button-sm"
          (onClick)="contribution.expanded = !contribution.expanded"
          [pTooltip]="'CONTRIBUTIONS.TOOLTIPS.VIEW_DETAILS' | translate">
        </p-button>
        <p-button
          icon="pi pi-trash"
          class="p-button-rounded p-button-text p-button-sm"
          (onClick)="onDeleteContribution(contribution)"
          [pTooltip]="'CONTRIBUTIONS.TOOLTIPS.DELETE' | translate">
        </p-button>
      </td>
    </tr>

    <tr *ngIf="contribution.expanded">
      <td colspan="5" class="p-0">
        <div class="p-3 bg-gray-50">
          <h6 class="mb-2">{{ 'CONTRIBUTIONS.DETAILS.TITLE' | translate }}</h6>

          <p-table
            [value]="contribution.details"
            styleClass="p-datatable-nested p-datatable-sm">

            <ng-template pTemplate="header">
              <tr>
                <th>{{ 'CONTRIBUTIONS.DETAILS.HEADER.MEMBER' | translate }}</th>
                <th>{{ 'CONTRIBUTIONS.DETAILS.HEADER.ROLE' | translate }}</th>
                <th>{{ 'CONTRIBUTIONS.DETAILS.HEADER.AMOUNT' | translate }}</th>
                <th>{{ 'CONTRIBUTIONS.DETAILS.HEADER.STATUS' | translate }}</th>
                <th>{{ 'CONTRIBUTIONS.DETAILS.HEADER.PAYMENT_DATE' | translate }}</th>
                <th>{{ 'CONTRIBUTIONS.DETAILS.HEADER.RECEIPTS' | translate }}</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-detail>
              <tr>
                <td>{{ detail.displayName || ('CONTRIBUTIONS.DETAILS.NO_NAME' | translate) }}</td>

                <td>
                  <span class="p-tag p-tag-sm"
                        [class]="detail.displayRole === 'REPRESENTANTE' ? 'p-tag-success' : 'p-tag-info'">
                    {{
                      (detail.displayRole === 'REPRESENTANTE'
                        ? 'CONTRIBUTIONS.ROLES.REPRESENTATIVE'
                        : 'CONTRIBUTIONS.ROLES.MEMBER') | translate
                    }}
                  </span>
                </td>

                <td>{{ detail.monto | currency:'PEN':'symbol':'1.2-2' }}</td>

                <td>
                  <span class="p-tag p-tag-sm" [class]="getStatusClass(detail.status)">
                    {{ getStatusLabel(detail.status) }}
                  </span>
                </td>

                <td>
                  {{
                    (detail.pagadoEn || detail.pagado_en)
                      ? ((detail.pagadoEn || detail.pagado_en) | date:'dd/MM/yyyy')
                      : '-'
                  }}
                </td>

                <td class="flex align-items-center gap-2">
                  <p-button
                    icon="pi pi-inbox"
                    class="p-button-rounded p-button-text p-button-sm"
                    [badge]="detail.pendingReceiptsCount || 0"
                    [badgeClass]="(detail.pendingReceiptsCount || 0) > 0 ? 'p-badge-warning' : 'p-badge-secondary'"
                    [pTooltip]="'CONTRIBUTIONS.DETAILS.REVIEW_RECEIPTS' | translate"
                    (onClick)="openReviewDialog(detail)">
                  </p-button>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="6" class="text-center text-gray-500 py-3">
                  {{ 'CONTRIBUTIONS.DETAILS.EMPTY_MESSAGE' | translate }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="5" class="text-center text-gray-500 py-4">
        {{ 'CONTRIBUTIONS.TABLE.EMPTY_MESSAGE' | translate }}
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [header]="'CONTRIBUTIONS.REVIEW_DIALOG.TITLE' | translate"
  [(visible)]="reviewDialogVisible"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '50vw' }">

  <div *ngIf="!reviewForDetail">
    <p class="text-gray-500">{{ 'CONTRIBUTIONS.REVIEW_DIALOG.NO_DETAIL' | translate }}</p>
  </div>

  <div *ngIf="reviewForDetail">
    <p class="mb-3">
      <strong>{{ 'CONTRIBUTIONS.REVIEW_DIALOG.MEMBER' | translate }}:</strong>
      {{ reviewForDetail.displayName }}
      &middot;
      <strong>{{ 'CONTRIBUTIONS.REVIEW_DIALOG.AMOUNT' | translate }}:</strong>
      {{ reviewForDetail.monto | currency:'PEN':'symbol':'1.2-2' }}
      &middot;
      <strong>{{ 'CONTRIBUTIONS.REVIEW_DIALOG.STATUS' | translate }}:</strong>
      <span class="p-tag p-tag-sm" [class]="getStatusClass(reviewForDetail.status)">
        {{ getStatusLabel(reviewForDetail.status) }}
      </span>
    </p>

    <p-table
      [value]="reviewReceipts"
      [loading]="reviewLoading"
      styleClass="p-datatable-sm">

      <ng-template pTemplate="header">
        <tr>
          <th>#</th>
          <th>{{ 'CONTRIBUTIONS.REVIEW_DIALOG.FILE' | translate }}</th>
          <th>{{ 'CONTRIBUTIONS.REVIEW_DIALOG.UPLOADED_AT' | translate }}</th>
          <th>{{ 'CONTRIBUTIONS.REVIEW_DIALOG.STATUS' | translate }}</th>
          <th class="text-center">{{ 'CONTRIBUTIONS.REVIEW_DIALOG.ACTIONS' | translate }}</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-r let-i="rowIndex">
        <tr>
          <td>{{ i + 1 }}</td>
          <td>
            <p-button
              icon="pi pi-download"
              class="p-button-rounded p-button-text p-button-sm"
              [pTooltip]="'CONTRIBUTIONS.REVIEW_DIALOG.DOWNLOAD' | translate"
              (onClick)="downloadReceipt(r)">
            </p-button>
          </td>
          <td>{{ r.uploadedAt ? (r.uploadedAt | date:'dd/MM/yyyy HH:mm') : '-' }}</td>
          <td>
            <span class="p-tag p-tag-sm" [class]="receiptTagClass(r.status)">
              {{
                r.status === 'PENDING'  ? ('CONTRIBUTIONS.REVIEW_DIALOG.PENDING'  | translate) :
                  r.status === 'APPROVED' ? ('CONTRIBUTIONS.REVIEW_DIALOG.APPROVED' | translate) :
                    ('CONTRIBUTIONS.REVIEW_DIALOG.REJECTED' | translate)
              }}
            </span>
          </td>
          <td class="text-center">
            <div class="flex justify-content-center gap-2">
              <p-button
                icon="pi pi-check"
                class="p-button-rounded p-button-success p-button-sm"
                [disabled]="r.status !== 'PENDING'"
                [pTooltip]="'CONTRIBUTIONS.REVIEW_DIALOG.APPROVE' | translate"
                (onClick)="approveReceipt(r)">
              </p-button>
              <p-button
                icon="pi pi-times"
                class="p-button-rounded p-button-danger p-button-sm"
                [disabled]="r.status !== 'PENDING'"
                [pTooltip]="'CONTRIBUTIONS.REVIEW_DIALOG.REJECT' | translate"
                (onClick)="rejectReceipt(r)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center text-gray-500 py-3">
            {{ 'CONTRIBUTIONS.REVIEW_DIALOG.EMPTY' | translate }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>

<p-dialog
  [header]="'CONTRIBUTIONS.DIALOG.HEADER_CREATE' | translate"
  [(visible)]="mostrarDialogo"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '40vw' }">

  <form [formGroup]="contributionForm" (ngSubmit)="guardarContribution()">
    <div class="p-field mb-3">
      <label for="billId" class="block mb-2 font-medium">
        {{ 'CONTRIBUTIONS.FORM.BILL_LABEL' | translate }}
      </label>
      <p-dropdown
        formControlName="billId"
        [options]="bills"
        optionLabel="description"
        optionValue="id"
        [placeholder]="'CONTRIBUTIONS.FORM.BILL_PLACEHOLDER' | translate"
        class="w-full">
      </p-dropdown>
      <small class="p-error"
             *ngIf="contributionForm.get('billId')?.errors?.['required'] && contributionForm.get('billId')?.touched">
        {{ 'CONTRIBUTIONS.FORM.BILL_REQUIRED' | translate }}
      </small>
    </div>

    <div class="p-field mb-3">
      <label for="description" class="block mb-2 font-medium">
        {{ 'CONTRIBUTIONS.FORM.DESCRIPTION_LABEL' | translate }}
      </label>
      <input
        id="description"
        type="text"
        pInputText
        formControlName="description"
        [placeholder]="'CONTRIBUTIONS.FORM.DESCRIPTION_PLACEHOLDER' | translate"
        class="w-full" />
      <small class="p-error"
             *ngIf="contributionForm.get('description')?.errors?.['required'] && contributionForm.get('description')?.touched">
        {{ 'CONTRIBUTIONS.FORM.DESCRIPTION_REQUIRED' | translate }}
      </small>
    </div>

    <div class="p-field mb-3">
      <label for="fechaLimite" class="block mb-2 font-medium">
        {{ 'CONTRIBUTIONS.FORM.DUE_DATE_LABEL' | translate }}
      </label>
      <p-calendar
        formControlName="fechaLimite"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        [showButtonBar]="true"
        appendTo="body"
        [placeholder]="'CONTRIBUTIONS.FORM.DUE_DATE_PLACEHOLDER' | translate"
        class="w-full">
      </p-calendar>
      <small class="p-error"
             *ngIf="contributionForm.get('fechaLimite')?.errors?.['required'] && contributionForm.get('fechaLimite')?.touched">
        {{ 'CONTRIBUTIONS.FORM.DUE_DATE_REQUIRED' | translate }}
      </small>
    </div>

    <div class="p-field mb-3">
      <label for="strategy" class="block mb-2 font-medium">
        {{ 'CONTRIBUTIONS.FORM.STRATEGY_LABEL' | translate }}
      </label>
      <p-dropdown
        formControlName="strategy"
        [options]="estrategias"
        optionLabel="label"
        optionValue="value"
        [placeholder]="'CONTRIBUTIONS.FORM.STRATEGY_PLACEHOLDER' | translate"
        class="w-full">
      </p-dropdown>
      <small class="p-error"
             *ngIf="contributionForm.get('strategy')?.errors?.['required'] && contributionForm.get('strategy')?.touched">
        {{ 'CONTRIBUTIONS.FORM.STRATEGY_REQUIRED' | translate }}
      </small>
    </div>

    <div class="p-field mb-3">
      <label for="miembros" class="block mb-2 font-medium">
        {{ 'CONTRIBUTIONS.FORM.MEMBERS_LABEL' | translate }} <small class="text-gray-500">(opcional)</small>
      </label>
      <p-multiSelect
        formControlName="miembros"
        [options]="miembros"
        optionLabel="name"
        optionValue="id"
        display="chip"
        [showClear]="true"
        appendTo="body"
        [placeholder]="'CONTRIBUTIONS.FORM.MEMBERS_PLACEHOLDER' | translate"
        class="w-full">
        <ng-template let-option pTemplate="item">
          <div class="flex align-items-center">
            <span class="ml-2">{{ option.name }}</span>
            <span class="ml-auto">
              <small class="text-gray-500">
                ({{ (option.role === 'REPRESENTANTE'
                ? 'CONTRIBUTIONS.ROLES.REPRESENTATIVE'
                : 'CONTRIBUTIONS.ROLES.MEMBER') | translate }})
              </small>
            </span>
          </div>
        </ng-template>
      </p-multiSelect>
    </div>

    <div class="p-field mb-3" *ngIf="contributionForm.get('billId')?.value">
      <div class="p-3 bg-blue-50 border-round">
        <h6 class="mt-0 mb-2">{{ 'CONTRIBUTIONS.FORM.BILL_INFO_TITLE' | translate }}</h6>
        <p class="m-0">
          <strong>{{ 'CONTRIBUTIONS.FORM.TOTAL_AMOUNT_LABEL' | translate }}</strong>
          <input
            type="text"
            pInputText
            [value]="selectedBillMonto | currency:'PEN':'symbol':'1.2-2'"
            readonly />
        </p>
        <p class="m-0 mt-1" *ngIf="contributionForm.get('miembros')?.value?.length > 0">
          <strong>{{ 'CONTRIBUTIONS.FORM.SELECTED_MEMBERS_LABEL' | translate }}</strong>
          {{ contributionForm.get('miembros')?.value?.length }}
        </p>
      </div>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
      <p-button
        type="button"
        [label]="'CONTRIBUTIONS.FORM.CANCEL_BUTTON' | translate"
        severity="secondary"
        (onClick)="cerrarDialogo()">
      </p-button>
      <p-button
        type="submit"
        [label]="'CONTRIBUTIONS.FORM.SAVE_BUTTON' | translate"
        [disabled]="contributionForm.invalid || loading"
        [loading]="loading">
      </p-button>
    </div>
  </form>
</p-dialog>
